#!/usr/bin/env bash

set -euo pipefail

export PATH=$(dirname "$(pwd)/${0}"):$PATH

export AWS_PROFILE=kalaclista
export AWS_REGION=us-east-1
export S3_BUCKET=kalaclista

cd "$(dirname "${0}")/../"

main() {
  if test ! -e latest/sha256sum.txt ; then
    cd public

    find . -type f \
      | sed 's!./!!' \
      | xargs -I{} -P$(nproc --all --ignore 1) \
        bash -c "echo cp --cache-control \$(cache-control '{}') 'public/{}' 's3://${S3_BUCKET}/{}'" \
      >../latest/upload.txt

    cd ..

  else
    test ! -e latest/upload.txt || rm latest/upload.txt
    sha256sum -c latest/sha256sum.txt \
      | grep -i failed \
      | cut -d: -f1 \
      | xargs -I{} -P$(nproc --all --ignore 1) \
      bash -c "(test -e '{}' && echo \"cp --cache-control $(cache-control '{}') '{}' 's3://${S3_BUCKET}/{}'\") || echo rm 's3://${S3_BUCKET}/{}'" >>latest/upload.txt || true
  fi

  if test ! -z "$(cat latest/upload.txt)"; then
    s5cmd run latest/upload.txt 
    find public -type f | xargs -I{} -P$(nproc --all --ignore 1) sha256sum '{}' >latest/sha256sum.txt
  fi
}

main "${@}"
